image: alpine:latest
stages:
  - build

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"

.build:
  # Create jobs, but don't run them unless this is
  # overriden in jobs that extend it
  stage: build
  interruptible: true
  before_script:
    # upgrade is mostly needed for "qemu" runners that run edge based on a VM
    # The other build jobs run natively in docker on latest alpine stable and
    # those should always have whatever we need
    - apk upgrade -U
    - .ci/lib/gitlab_prepare_ci.sh
  after_script:
    - cp -r /home/pmos/.local/var/pmbootstrap/packages/ packages/ || true
    - .ci/lib/move_logs.sh $CI_PROJECT_DIR
  artifacts:
    expire_in: 1 week
    paths:
      - packages/
  timeout: 10 h

build:
  extends: .build
  parallel:
    matrix:
{% if ('x86_64' in archs) %}
      - ARCH: x86_64
        TAG: shared
{% endif %}
{% if ('x86' in archs) %}
      - ARCH: x86
        TAG: shared
{% endif %}
{% if ('aarch64' in archs) %}
      - ARCH: aarch64
        TAG: arm64
{% endif %}
{% if ('armv7' in archs) %}
      - ARCH: armv7
        TAG: qemu
{% endif %}
{% if ('armhf' in archs) %}
      - ARCH: armhf
        TAG: qemu
{% endif %}
{% if ('riscv64' in archs) %}
      - ARCH: riscv64
        TAG: qemu
{% endif %}
{% if archs|length == 0 %}
      - ARCH: placeholder
        TAG: shared
{% endif %}
  tags:
    - $TAG
  script:
# Needed because gitlab fails if no jobs are ran:
#  - https://gitlab.com/gitlab-org/gitlab/-/issues/368248
{% if archs|length == 0 %}
    - 'true'
{% else %}
    - .ci/build-$ARCH.sh
{% endif %}
