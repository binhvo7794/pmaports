# Maintainer: Jens Reidel <adrian@travitia.xyz>

pkgname=firmware-qcom-sm7150
pkgver=1
pkgrel=0
url="https://github.com/sm7150-mainline"
pkgdesc="Firmware for Qualcomm SM7150 devices"
arch="aarch64"
license="proprietary"
makedepends="
	qca-swiss-army-knife
	zstd
"
options="!check !strip !archcheck !tracedeps pmb:cross-native"
subpackages="
	$pkgname-ath10k:ath10k
"
depends="
	$pkgname-ath10k
	firmware-xiaomi-davinci
	firmware-xiaomi-surya
	linux-firmware-qca
	linux-firmware-qcom
"

_ath10k_fw_url="https://github.com/sm7150-mainline/$pkgname-ath10k"
_ath10k_fw_commit="be80ef2e19357152ed9185ba8fd912a9624d84e3"

source="
	$pkgname-ath10k-$_ath10k_fw_commit.tar.gz::$_ath10k_fw_url/archive/$_ath10k_fw_commit/$pkgname-ath10k-$_ath10k_fw_commit.tar.gz
"

package() {
	mkdir -p "$pkgdir"
}

ath10k() {
	pkgdesc="WiFi firmware for Qualcomm SM7150 devices"
	replaces="linux-firmware-ath10k"

	export ZSTD_CLEVEL=19

	cd "$srcdir/$subpkgname-$_ath10k_fw_commit"

	# Create a board-2.bin file - this contains the list of device-specific
	# bdwlan files and their corresponding calibration variant properties
	ath10k-bdencoder -c board-2.json
	zstd --compress board-2.bin
	install -Dm644 board-2.bin.zst -t "$subpkgdir/lib/firmware/ath10k/WCN3990/hw1.0"

	# Create a firmware-5.bin file - this contains feature information about
	# the WCN3990 module
	ath10k-fwencoder --create \
		--features=wowlan,no-nwifi-decap-4addr-padding,allows-mesh-bcast,mgmt-tx-by-ref,non-bmi,single-chan-info-per-channel  \
		--set-wmi-op-version=tlv --set-htt-op-version=tlv \
		--set-fw-api=5
	zstd --compress firmware-5.bin
	install -Dm644 firmware-5.bin.zst -t "$subpkgdir/lib/firmware/ath10k/WCN3990/hw1.0"
}

sha512sums="
e3e2df03f29fbe31e4fbaead50ababc0fb8eacbd0fa09401cb4d2d8ea4dd613f89e1aefcf28940d6edb265807a9a85e768c5c8946c31b457085e87b4586b7598  firmware-qcom-sm7150-ath10k-be80ef2e19357152ed9185ba8fd912a9624d84e3.tar.gz
"
