pkgname=u-boot-pine64-pinenote
pkgver=2023.04_git20232303
pkgrel=2
pkgdesc="u-boot bootloader for the Pinenote (rk3566)"
url="https://gitlab.com/a-wai/u-boot-pinenote"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
options="!check"

makedepends="
	arm-trusted-firmware
	bc
	bison
	dtc
	flex
	libfdt
	make
	openssl-dev
	py3-elftools
	py3-setuptools
	python3-dev
	swig
	u-boot-tools
"

_commit="2e0e11b8e65c48a43270f4ec4a88b74c8a83e269"
_ram_commit="9e44f3e17cc51378df294fcd909be48c0f07b47b"

builddir=$srcdir/u-boot-rockchip-$_commit

source="
	$pkgname-$_commit.tar.gz::https://github.com/Kwiboo/u-boot-rockchip/archive/$_commit.tar.gz
	https://github.com/rockchip-linux/rkbin/raw/$_ram_commit/bin/rk35/rk3566_ddr_1056MHz_v1.16.bin
	https://github.com/PNDeb/pinenote-debian-image/releases/download/v20250101_01/rk356x_spl_loader_v1.12.112.bin
	libfdt.i_shipped-use-SWIG_AppendOutput.patch
"

build() {
	export ROCKCHIP_TPL="$srcdir"/rk3566_ddr_1056MHz_v1.16.bin
	export BL31="/usr/share/arm-trusted-firmware/rk3568/bl31.elf"

	make pinenote-rk3566_defconfig
	make

	# make idbloader.img
	mkimage -n rk3568 -T rksd -d "$ROCKCHIP_TPL:$builddir"/spl/u-boot-spl.bin "$builddir"/idbloader.img
}

package() {
	install -Dm644 "$builddir"/u-boot-dtb.bin "$pkgdir"/usr/share/u-boot/pine64-pinenote/u-boot.bin
	install -Dm644 "$builddir"/idbloader.img "$pkgdir"/usr/share/u-boot/pine64-pinenote/idbloader.img
	install -Dm644 "$builddir"/u-boot.itb "$pkgdir"/usr/share/u-boot/pine64-pinenote/u-boot.itb
	install -Dm644 "$srcdir"/rk356x_spl_loader_v1.12.112.bin "$pkgdir"/usr/share/u-boot/pine64-pinenote/.
}

sha512sums="
7cc310164fb04986acd9e3aca6df6279ee65edd5f51167f9fd011c405bd503ee5811cd4ebca8fa79ec312335ed4e8006b79523c6312b46bf670f8305c8c5c228  u-boot-pine64-pinenote-2e0e11b8e65c48a43270f4ec4a88b74c8a83e269.tar.gz
4cac163b76bfe405dbe3889ed146c9e2af384862b9c9e17e6bad3ad036a206e7160deee0a319eff5d25d512b3ab89d313183fde6848da6117540363f4416dad8  rk3566_ddr_1056MHz_v1.16.bin
386fcd19d53cf2af5bb7a704d9c6e9fc5b05bf5c1aba7d4e052dc83e57c416b4e85074b2486c7f31f7618e50931bce00fbe425e46e01445653445b0fded67537  rk356x_spl_loader_v1.12.112.bin
016ef30dbbb1021dad4f58eeda3f5a5e89ff3a76dbc69e8e4cf6a3fc3983aef998cfe1087abb4b21bb2f859bd5cffe26c1da42d13f1c3d2e3c053c399f38720b  libfdt.i_shipped-use-SWIG_AppendOutput.patch
"
